# GUÍA COMPLETA DE MIGRACIÓN

## Elasticsearch 7.17.29 → Elasticsearch 8.x

## Para entornos HA con 2 nodos (rolling upgrade)

---

# 0. CONTEXTO TÉCNICO DE TU ENTORNO

Confirmado:

* Elasticsearch 7.17.29
* Kibana 7.17.29
* 2 nodos en cluster (es-node-1 y es-node-2)
* `xpack.security.enabled: false`
* Indices como logs-demo, products-advanced, etc.
* Todo funcionando en estado **green**

**Perfecto para migrar.**

---

# 1. PREPARACIÓN (OBLIGATORIO)

Antes de tocar nada:

## 1.1. Verifica estado del cluster

En cualquiera de los nodos:

```bash
curl -s http://localhost:9200/_cluster/health?pretty
curl -s http://localhost:9200/_cat/nodes?v
curl -s http://localhost:9200/_cat/indices?v
```

El cluster debe estar:

```
status: "green"
number_of_nodes: 2
```

Si no está green, NO migres.

---

## 1.2. Revisa Breaking Changes desde Kibana

Ruta:

**Stack Management → Upgrade Assistant**

Debes asegurarte de que:

* No hay índices corruptos
* No hay plugins incompatibles (en tu caso no usas plugins externos)
* No hay mensajes severos

En un cluster simple como el tuyo, el Upgrade Assistant normalmente aparece limpio.

---

## 1.3. Crear Snapshot (muy importante)

Esto te garantiza rollback si algo falla.

Primero define un repositorio (si no existe):

```bash
curl -X PUT "http://localhost:9200/_snapshot/backup_repo" -H 'Content-Type: application/json' -d '
{
  "type": "fs",
  "settings": {
    "location": "/var/lib/elasticsearch/backups"
  }
}'
```

Crea carpeta en ambos nodos:

```bash
sudo mkdir -p /var/lib/elasticsearch/backups
sudo chown -R elasticsearch:elasticsearch /var/lib/elasticsearch/backups
```

Crear snapshot:

```bash
curl -X PUT "http://localhost:9200/_snapshot/backup_repo/preupgrade_snapshot?wait_for_completion=true"
```

Debes ver “SUCCESS”.

---

# 2. ROLLING UPGRADE (Migración nodo por nodo)

La clave para **NO perder datos** es:

* Nunca detener ambos nodos a la vez
* Crear snapshot
* Asegurar estado green antes de avanzar

Usaremos este orden:

1. es-node-1
2. es-node-2
3. Kibana
4. Validación final

---

# 3. ACTUALIZAR NODO 1 (es-node-1)

## 3.1. Asegura que shards tengan réplica actualizada

Fuerza una reasignación suave:

```bash
curl -X POST "http://localhost:9200/_cluster/reroute?retry_failed"
```

---

## 3.2. Detener Elasticsearch en nodo 1

```bash
sudo systemctl stop elasticsearch
```

Confirma que está detenido:

```bash
sudo systemctl status elasticsearch
```

---

## 3.3. Instalar Elasticsearch 8.x

Primero actualiza repos:

```bash
sudo apt-get update
```

Luego instala la versión 8.15.x (ejemplo estable):

```bash
sudo apt-get install elasticsearch=8.15.0
```

Si tu distro usa yum:

```bash
sudo yum install elasticsearch-8.15.0
```

---

## 3.4. Ajustar elasticsearch.yml

Elastic 8.x activa seguridad automáticamente; como tú no la usas todavía, agrega:

En `/etc/elasticsearch/elasticsearch.yml`:

```
xpack.security.enabled: false
xpack.security.transport.ssl.enabled: false
```

NO borres otras líneas.

---

## 3.5. Iniciar Elasticsearch 8 en nodo 1

```bash
sudo systemctl start elasticsearch
```

Validar que subió:

```bash
curl -s http://localhost:9200/
```

Debes ver:

```
"number" : "8.15.0",
"cluster_name" : "your-cluster",
```

---

## 3.6. Esperar a que el cluster vuelva a green

En cualquiera de los nodos:

```bash
curl -s http://localhost:9200/_cluster/health?pretty
```

Debe pasar por:

* yellow
* luego green

**NO pases al nodo 2 hasta que esté green.**

---

# 4. ACTUALIZAR NODO 2 (es-node-2)

Mismo proceso:

---

## 4.1. Detén Elasticsearch

```bash
sudo systemctl stop elasticsearch
```

---

## 4.2. Instala Elasticsearch 8.x

```bash
sudo apt-get update
sudo apt-get install elasticsearch=8.15.0
```

---

## 4.3. Ajustar elasticsearch.yml

```
xpack.security.enabled: false
xpack.security.transport.ssl.enabled: false
```

---

## 4.4. Inicia Elasticsearch

```bash
sudo systemctl start elasticsearch
```

---

## 4.5. Validar cluster green

```bash
curl -s http://localhost:9200/_cluster/health?pretty
```

Debes ver:

```
status: "green"
number_of_nodes: 2
```

---

# 5. MIGRAR KIBANA 7.17 → 8.x

Sin Kibana, el cluster no sirve para tus alumnos, así que este paso es crucial.

---

## 5.1. Detener Kibana

```bash
sudo systemctl stop kibana
```

---

## 5.2. Instalar Kibana 8.x

```bash
sudo apt-get install kibana=8.15.0
```

---

## 5.3. Ajustar kibana.yml

En `/etc/kibana/kibana.yml`:

```
elasticsearch.hosts: ["http://<IP-node-1>:9200","http://<IP-node-2>:9200"]
elasticsearch.ssl.verificationMode: none
```

Si quieres mantener seguridad desactivada:

```
xpack.security.enabled: false
```

---

## 5.4. Iniciar Kibana

```bash
sudo systemctl start kibana
```

Ir al navegador:

```
http://<IP>:5601
```

Kibana 8.x ya debería cargar.

---

# 6. POST-UPGRADE (validaciones finales)

## 6.1. Ver nodes

```
GET _cat/nodes?v
```

Debe mostrar:

```
8.15.0
8.15.0
```

---

## 6.2. Ver índices

```
GET _cat/indices?v
```

No debe haber índices rojos.

---

## 6.3. Ver shards

```
GET _cat/shards?v
```

---

## 6.4. Kibana

Confirmar:

* Discover carga
* Visualize funciona
* Index Management funciona
* No hay errores de consola

---

# 7. ¿CUÁNTO TIEMPO TOMA?

Para un cluster de 2 nodos como el tuyo:

* Nodo 1: 5–10 min
* Nodo 2: 5–10 min
* Kibana: 3–5 min

Tiempo total: **20–30 minutos** si sigues la guía sin interrupciones.

---

# 8. SI PASA ALGO: ROLLBACK

Tienes 2 formas:

## Opción A: Restaurar snapshot (ideal)

```
POST _snapshot/backup_repo/preupgrade_snapshot/_restore
```

## Opción B: Volver a instalar ES/Kibana 7.17

```bash
sudo apt-get install elasticsearch=7.17.29
sudo apt-get install kibana=7.17.29
```

---
