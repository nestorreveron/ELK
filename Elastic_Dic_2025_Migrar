

### ğŸŸ¦ Cluster Elasticsearch

| Nodo      | IP privada | VersiÃ³n | Roles              | Kibana |
| --------- | ---------- | ------- | ------------------ | ------ |
| es-node-1 | 10.10.1.4  | 7.17.29 | master/data/ingest | **SÃ­** |
| es-node-2 | 10.10.1.5  | 7.17.29 | master/data/ingest | No     |
| es-node-3 | 10.10.1.6  | 7.17.29 | master/data/ingest | No     |

### ğŸŸ¦ Kibana HA (parcial)

Actualmente **solo hay Kibana en es-node-1**, por lo tanto:

* El Load Balancer **no aplica aÃºn**
* Debemos instalar Kibana en **es-node-2** luego del upgrade
* Luego reconstruimos correctamente el HA con las claves de encripciÃ³n

### ğŸŸ¦ Ãndices

Todos tus Ã­ndices tienen:

```
pri: 1
rep: 1
```

Excelente: **esto permite rolling upgrade real sin pÃ©rdida de datos.**

### ğŸŸ¦ VersiÃ³n destino

**Elasticsearch / Kibana 8.15.0 (estable y recomendada)**

---

# ğŸŸ¥ **PARTE 1 â€“ PreparaciÃ³n y snapshot (obligatorio)**

## 1.1. Verificar estado real del cluster

En es-node-1:

```bash
curl -s http://localhost:9200/_cluster/health?pretty
curl -s http://localhost:9200/_cat/nodes?v
curl -s http://localhost:9200/_cat/indices?v
```

Debes ver:

```
status: "green"
number_of_nodes: 3
```

---

## 1.2. Crear un repositorio de snapshots en los tres nodos

### 1) Crear carpeta fÃ­sica

Ejecuta esto en **es-node-1, es-node-2 y es-node-3**:

```bash
sudo mkdir -p /var/lib/elasticsearch/backups
sudo chown -R elasticsearch:elasticsearch /var/lib/elasticsearch/backups
```

### 2) Registrar repositorio:

```bash
curl -X PUT "http://10.10.1.4:9200/_snapshot/backup_repo" -H "Content-Type: application/json" -d '
{
  "type": "fs",
  "settings": {
    "location": "/var/lib/elasticsearch/backups"
  }
}'
```

### 3) Crear snapshot completo

```bash
curl -X PUT "http://10.10.1.4:9200/_snapshot/backup_repo/preupgrade?wait_for_completion=true"
```

Debe devolver:

```
"state": "SUCCESS"
```

---

# ğŸŸ¦ Â¿QuÃ© logramos hasta aquÃ­?

âœ” Tienes respaldo completo
âœ” Puedes restaurar si falla algo
âœ” Ãndices con rÃ©plica â†’ seguro hacer rolling upgrade
âœ” Listo para migraciÃ³n

---

# ğŸŸ¥ **PARTE 2 â€“ Rolling Upgrade de Elasticsearch 7.17 â†’ 8.15 (3 nodos)**

Regla de oro:

**Nunca parar mÃ¡s de un nodo a la vez.**

El orden recomendado segÃºn Elastic es:

1. Nodos data/ingest
2. Nodos master elegidos
3. Supervisar cluster
4. Repetir

Como tus nodos cumplen todos los roles, lo hacemos asÃ­:

â¡ Primero **es-node-1**
â¡ Luego **es-node-2**
â¡ Ãšltimo **es-node-3**

---

# ğŸŸ© **NODO 1 â€” es-node-1 (10.10.1.4)**

## 2.1. Parar servicio

```bash
sudo systemctl stop elasticsearch
```

---

## 2.2. Instalar Elasticsearch 8.15.0
#Importar nuevamente la clave GPG (vÃ¡lida para 8.x)

curl -fsSL https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo gpg --dearmor -o /usr/share/keyrings/elastic-8.gpg

#Crear el repositorio 8.x

echo "deb [signed-by=/usr/share/keyrings/elastic-8.gpg] https://artifacts.elastic.co/packages/8.x/apt stable main" | \
  sudo tee /etc/apt/sources.list.d/elastic-8.x.list


```bash
sudo apt update
sudo apt install elasticsearch=8.15.0
```

Si el repo no tiene pinning, instalar Ãºltima 8.x:

```bash
sudo apt install elasticsearch
```

---

## 2.3. Ajustar elasticsearch.yml

Abre el archivo:

```bash
sudo nano /etc/elasticsearch/elasticsearch.yml
```

Reemplaza/asegura:

```yaml
cluster.name: kyndryl-elk-lab

node.name: es-node-1
node.roles: [ master, data, ingest ]

network.host: 0.0.0.0
http.port: 9200

discovery.seed_hosts: ["10.10.1.4","10.10.1.5","10.10.1.6"]

cluster.initial_master_nodes: ["es-node-1","es-node-2","es-node-3"]

xpack.security.enabled: false
xpack.security.transport.ssl.enabled: false
```

---

## 2.4. Iniciar servicio

```bash
sudo systemctl start elasticsearch
```

---

## 2.5. Verifica nodo actualizado

```bash
curl -s http://10.10.1.4:9200/
```

Debe mostrar:

```
"number" : "8.15.0"
```

---

## 2.6. Verifica cluster green

```bash
curl -s http://10.10.1.4:9200/_cluster/health?pretty
```

Debe quedar:

```
status: "green"
number_of_nodes: 3
```

**No avances a nodo 2 hasta que el cluster estÃ© green.**

---

# ğŸŸ© **NODO 2 â€” es-node-2 (10.10.1.5)**

**Mismos pasos exactos:**

1. Stop servicio
2. Instalar ES 8.15.0
3. Editar elasticsearch.yml
4. Start
5. Verificar health green

---

# ğŸŸ© **NODO 3 â€” es-node-3 (10.10.1.6)**

Mismos pasos.

---

# ğŸŸ© **Resultado esperado del cluster**

Ejecutar:

```bash
curl -s http://10.10.1.4:9200/_cat/nodes?v
```

Debe mostrar algo como:

```
es-node-1 8.15.0
es-node-2 8.15.0
es-node-3 8.15.0
```

Y health:

```
green
```

---

# ğŸŸ¥ PARTE 3 â€“ Kibana HA + Upgrade 7.17 â†’ 8.15

Actualmente:

Si ya agregaste el repo 8.x al instalar Elasticsearch 8.x:
deb https://artifacts.elastic.co/packages/8.x/apt stable main

Entonces no necesitas hacer nada extra, porque Elasticsearch y Kibana usan el mismo repositorio.
* es-node-1 â†’ Kibana 7.17
* es-node-2 â†’ **No tiene Kibana**
* Queremos completar un HA real: dos instancias idÃ©nticas detrÃ¡s del LB.

---

# ğŸŸ© Paso 3.1 â€” Actualizar Kibana en es-node-1

```bash
sudo systemctl stop kibana
sudo apt update
sudo apt install kibana=8.15.0
```

---

# ğŸŸ© Paso 3.2 â€” Instalar Kibana desde cero en es-node-2

```bash
sudo apt update
sudo apt install kibana=8.15.0
```

---

# ğŸŸ© Paso 3.3 â€” Configurar HA con claves idÃ©nticas

En **ambos nodos**:

```bash
sudo nano /etc/kibana/kibana.yml
```

Configura:

```yaml
server.host: "0.0.0.0"
server.port: 5601

elasticsearch.hosts: ["http://10.10.1.4:9200","http://10.10.1.5:9200","http://10.10.1.6:9200"]

xpack.security.enabled: false

xpack.encryptedSavedObjects.encryptionKey: "SuperClaveLargaDe32CaracteresMinimo123"
xpack.reporting.encryptionKey: "OtraClaveLargaDe32CaracteresMinimo456"
xpack.security.encryptionKey: "ClaveDiferenteLargaDe32CaracteresMinimo789"
```

**IMPORTANTE:**
Las **3 claves deben ser EXACTAMENTE iguales** en todos los Kibana.

---

# ğŸŸ© Paso 3.4 â€” Iniciar Kibana en ambos nodos

```bash
sudo systemctl enable kibana
sudo systemctl restart kibana
sudo systemctl status kibana
```

Debe quedar ambos:

```
active (running)
```

---

# ğŸŸ© Paso 3.5 â€” Validar HA con Load Balancer

En tu navegador:

```
http://<IP-publica-del-LB>:5601
```

DeberÃ¡s ver:

* Kibana 8.x
* Sin errores
* Todos los dashboards siguen funcionando

Luego prueba failover:

### Apaga Kibana del nodo 1:

```bash
sudo systemctl stop kibana
```

Refresca Kibana vÃ­a LB â†’ debe seguir funcionando (nodo 2 responde).

---

# ğŸŸ¥ PARTE 4 â€” Validaciones finales

Ejecuta:

```bash
curl -s http://10.10.1.4:9200/_cluster/health?pretty
curl -s http://10.10.1.4:9200/_cat/indices?v
curl -s http://10.10.1.4:9200/_cat/nodes?v
```

En Kibana:

* Discover
* Visualizations
* Dashboard
* Lens
* TSVB
* Reporting PDF

Todo debe funcionar mejor que antes.

---

# ğŸŸ© PARTE 5 â€” Rollback si algo fallara

## Restaurar snapshot:

```bash
curl -X POST "http://10.10.1.4:9200/_snapshot/backup_repo/preupgrade/_restore"
```

## Downgrade:

```bash
sudo apt install elasticsearch=7.17.29
sudo apt install kibana=7.17.29
```
#################################################################################################################################

Incluye:

âœ” Crear Ã­ndices desde cero
âœ” Ingestar datos (logs, mÃ©tricas y JSON personalizados)
âœ” Crear Data Views
âœ” Discover avanzado
âœ” Visualizaciones (Lens, TSVB, Metric, Pie, Bar, Heatmap)
âœ” Dashboards completos
âœ” CreaciÃ³n de usuarios + roles (seguridad nativa de ES 8)
âœ” Control de acceso por Ã­ndice
âœ” Alertas nativas en Kibana
âœ” ExportaciÃ³n de dashboards
âœ” Bonus: laboratorio de KQL y filtros globales

Todo **totalmente compatible con Kibana 8.15.x**.

---

# ğŸŸ¦ LAB COMPLETO â€” KIBANA 8.x PARA OPERACIONES & SEGURIDAD

---

# ğŸŸ© **1. Crear Ã­ndice desde cero (via API)**

ConÃ©ctate a cualquier nodo:

```bash
curl -X PUT "http://localhost:9200/app-logs" \
  -H 'Content-Type: application/json' \
  -d '{
    "mappings": {
      "properties": {
        "@timestamp": { "type": "date" },
        "service":    { "type": "keyword" },
        "status":     { "type": "integer" },
        "message":    { "type": "text" }
      }
    }
  }'
```

Verificar:

```bash
curl -X GET http://localhost:9200/_cat/indices?v
```

---

# ğŸŸ© **2. Insertar datos (logs simulados)**

```bash
curl -X POST "http://localhost:9200/app-logs/_bulk" \
  -H 'Content-Type: application/json' \
  -d '
{"index":{}}
{"@timestamp":"2025-01-01T12:00:00Z","service":"auth","status":200,"message":"Login success"}
{"index":{}}
{"@timestamp":"2025-01-01T12:01:00Z","service":"auth","status":401,"message":"Invalid password"}
{"index":{}}
{"@timestamp":"2025-01-01T12:02:00Z","service":"payments","status":500,"message":"DB timeout"}
{"index":{}}
{"@timestamp":"2025-01-01T12:03:00Z","service":"orders","status":200,"message":"Order created"}
'
```

---

# ğŸŸ© **3. Crear Data View en Kibana**

1. Entrar a kibana vÃ­a LB:

```
http://<LB-IP>:5601
```

2. Ir a:

```
Stack Management â†’ Data Views â†’ Create Data View
```

3. Crear:

* Nombre: **app-logs**
* Pattern: **app-logs***
* Campo de tiempo: **@timestamp**

Guardar.

---

# ğŸŸ© **4. DISCOVER â€” anÃ¡lisis inicial**

En Discover:

1. Seleccionar el Data View `app-logs`
2. Filtrar:

```
status >= 400
```

3. Campos Ãºtiles:

* service
* status
* message
* @timestamp

4. Ordenar por timestamp
5. AÃ±adir columnas personalizadas
6. Exportar resultados (CSV)

---

# ğŸŸ© **5. VISUALIZACIONES â€” LENS**

## 5.1. **Errores por minuto (Time Series)**

Lens:

* Drag @timestamp â†’ Horizontal axis
* Drag status â†’ Vertical axis
* Filtrar:

```
status >= 400
```

Cambiar tipo: **Area / Line**

Guardar como:

```
Errores por minuto
```

---

## 5.2. **Top servicios por volumen (Bar chart)**

Lens:

* Drag `service` â†’ Horizontal axis
* Drag `Records` â†’ Vertical axis
* Ordenar: Descending

Guardar:

```
Top servicios por volumen
```

---

## 5.3. **DistribuciÃ³n de cÃ³digos HTTP (Pie)**

Lens:

* Drag `status` â†’ Slice
* Drag `Records` â†’ Size

Guardar:

```
DistribuciÃ³n HTTP status
```

---

## 5.4. **Latencia promedio (Metric visualization) â€” Ã­ndice nuevo**

Creamos Ã­ndice para mÃ©tricas:

```bash
curl -X PUT "http://localhost:9200/metrics-demo" \
  -H 'Content-Type: application/json' \
  -d '{
    "mappings": {
      "properties": {
        "@timestamp": { "type": "date" },
        "service":    { "type": "keyword" },
        "latency_ms": { "type": "float" }
      }
    }
  }'
```

Insertar datos:

```bash
curl -X POST "http://localhost:9200/metrics-demo/_bulk" \
  -H 'Content-Type: application/json' \
  -d '
{"index":{}}
{"@timestamp":"2025-01-01T12:00:00Z","service":"auth","latency_ms":120}
{"index":{}}
{"@timestamp":"2025-01-01T12:00:00Z","service":"payments","latency_ms":450}
'
```

Crear DataView: `metrics-demo*`

VisualizaciÃ³n tipo **metric**:

* Metric: **Average latency_ms**
* Breakdown by: service

Guardar:

```
Latencia promedio por servicio
```

---

# ğŸŸ© **6. Dashboard completo**

Crear dashboard:

Nombre:

```
Observabilidad â€“ DÃ­a 4 Kibana 8.x
```

Agregar:

* Errores por minuto
* Top servicios por volumen
* DistribuciÃ³n de cÃ³digos HTTP
* Latencia promedio por servicio

Luego:

âœ” Ajustar layout
âœ” Filtros globales
âœ” Range time picker
âœ” Guardar dashboard

---

# ğŸŸ© **7. Laboratorio de KQL para alumnos**

En Discover o Dashboard â†’ Add filter.

1. Logs de un servicio:

```
service : "auth"
```

2. Errores:

```
status >= 400
```

3. Texto:

```
message : "timeout"
```

4. ExpresiÃ³n OR:

```
service : ("auth" or "payments")
```

5. CombinaciÃ³n:

```
service : "payments" and status >= 500
```

---

# ğŸŸ© **8. ACTIVAR SEGURIDAD EN ELASTICSEARCH 8 (opcional, recomendado para lab)**

En ES 8.x la seguridad estÃ¡ activada por defecto cuando no la desactivas.

Si tienes actualmente:

```
xpack.security.enabled: false
```

Puedes activar roles y usuarios:

---

## 8.1. Editar elasticsearch.yml en cada nodo

Quitar/descomentar:

```
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
```

Reiniciar:

```bash
sudo systemctl restart elasticsearch
```

---

## 8.2. Inicializar passwords de usuarios nativos

```bash
sudo /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic
```

TambiÃ©n puedes hacerlo para:

```
kibana_system
logstash_system
beats_system
```

---

## 8.3. Configurar Kibana para autenticaciÃ³n

En `/etc/kibana/kibana.yml`:

```
elasticsearch.username: "kibana_system"
elasticsearch.password: "<PASSWORD>"
```

Reiniciar Kibana:

```bash
sudo systemctl restart kibana
```

---

# ğŸŸ© **9. Crear usuarios y roles personalizados**

En Kibana:

```
Stack Management â†’ Security â†’ Users
```

Ejemplo: usuario `analista1`

Rol:

* Permiso `read` sobre Ã­ndices: `app-logs*`, `metrics-demo*`
* Permiso `read` en Dashboard, Visualize, Discover
* Sin permisos de gestiÃ³n

Crear usuario:

```
analista1 / Pass123!!
```

Probar login.

---

# ğŸŸ© **10. Crear alertas nativas**

En Kibana:

```
Observability â†’ Alerts
```

Ejemplo: alerta cuando errores > 5 por minuto.

Criterios:

* Rule type: **Elasticsearch query**
* Ãndice: app-logs
* Query:

```
status >= 500
```

* Threshold: Document count > 3
* Notify: email o log (simulado)

---

# ğŸŸ© **11. Exportar dashboard (PDF o PNG)**

En el dashboard:

```
Share â†’ Generate PDF
```

Validar que exporta correctamente.

---

# ğŸŸ© BONUS â€” LAB DE ANOMALÃAS (TSVB)

Crea visualizaciÃ³n TSVB:

* Panel type: Time Series
* Metric: Count()
* Group by: service
* Enable: Annotations (detect peaks)

Guardar como:

```
AnÃ¡lisis de anomalÃ­as por servicio
```
